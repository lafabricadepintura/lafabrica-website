<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paleta de Colores | La Fábrica</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --accent: #8bc34a; --bg: #1e1e1e; --card-bg: #2a2a2a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; }
        
        header { background: #252525; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 15px rgba(0,0,0,0.5); position: sticky; top: 0; z-index: 1000; }
        .logo-main { font-weight: bold; text-decoration: none; color: white; font-size: 1.2rem; }
        nav a { text-decoration: none; color: #bbb; margin-left: 20px; font-weight: 600; font-size: 0.9rem; }
        nav a.active { color: var(--accent); }

        .search-section { background: #151515; padding: 20px; text-align: center; }
        .filter-container { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; max-width: 1100px; margin: 15px auto 0; }
        .filter-badge { padding: 8px 18px; border-radius: 20px; background: #333; font-size: 0.8rem; cursor: pointer; border: 1px solid #444; color: #eee; text-transform: capitalize; }
        .filter-badge.active { background: var(--accent); color: #000; font-weight: bold; border-color: var(--accent); }

        .container { max-width: 1300px; margin: 20px auto; padding: 0 20px; }
        .sub-section { margin-bottom: 40px; }
        .sub-title { color: var(--accent); font-size: 1.1rem; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; font-weight: bold; }
        .sub-title::after { content: ""; flex: 1; height: 1px; background: #444; margin-left: 15px; }

        .color-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .color-card { background: var(--card-bg); border-radius: 10px; overflow: hidden; border: 1px solid #333; position: relative; }
        .color-sample { height: 100px; width: 100%; position: relative; }
        .popular-tag { background: var(--accent); color: #000; font-size: 9px; padding: 2px 5px; font-weight: bold; position: absolute; top: 0; left: 0; border-bottom-right-radius: 5px; }
        .color-info { padding: 10px; text-align: center; }
        .color-name { font-weight: bold; font-size: 0.75rem; display: block; height: 32px; overflow: hidden; }
        .color-id { font-size: 0.65rem; color: #888; margin-top: 5px; display: block; }
    </style>
</head>
<body>

<header>
    <a href="../index.html" class="logo-main">LA FÁBRICA <span style="color:var(--accent)">PINTURAS</span></a>
    <nav>
        <a href="../productos/index.html">PRODUCTOS</a>
        <a href="index.html" class="active">COLORES</a>
    </nav>
</header>

<section class="search-section">
    <div class="filter-container" id="badgesSpace"></div>
</section>

<div class="container" id="mainRenderSpace"></div>

<script>
    let colorData = [];
    let activeFamily = "Blanco"; 

    function loadCSV() {
        Papa.parse("paleta - Hoja 1.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                colorData = results.data;
                createFamilyBadges();
                renderStructured();
            }
        });
    }

    // LIMPIEZA MEJORADA: Ignora mayúsculas/minúsculas al limpiar
    function getFamily(type) {
        if (!type) return "";
        let t = type.trim();
        if (t.toLowerCase().includes("neutros")) return "Neutros";
        
        // El uso de /regex/i hace que sea insensible a mayúsculas (case-insensitive)
        return t.replace(/popular/i, "").replace(/soft/i, "").trim();
    }

    function createFamilyBadges() {
        const familyMap = new Set();
        colorData.forEach(c => {
            const f = getFamily(c.color_type);
            if(f) familyMap.add(f);
        });

        const families = Array.from(familyMap).sort((a, b) => {
            if(a === "Blanco" || a === "Neutros") return -1;
            return a.localeCompare(b);
        });

        const container = document.getElementById("badgesSpace");
        container.innerHTML = "";
        
        families.forEach(family => {
            const div = document.createElement("div");
            div.className = "filter-badge" + (family === activeFamily ? " active" : "");
            div.innerText = family;
            div.onclick = function() {
                activeFamily = family;
                document.querySelectorAll('.filter-badge').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                renderStructured();
            };
            container.appendChild(div);
        });
    }

    function renderStructured() {
        const container = document.getElementById("mainRenderSpace");
        container.innerHTML = "";

        // Usamos una comparación flexible para renderizar los subtítulos
        // Buscamos en la data los color_type que "contengan" las palabras clave
        const subOrden = ["popular", "base", "soft"];
        
        let subtiposReales = [...new Set(colorData
            .filter(c => getFamily(c.color_type) === activeFamily)
            .map(c => c.color_type.trim())
        )];

        // Ordenamos los subtipos encontrados según tu jerarquía
        subtiposReales.sort((a, b) => {
            const getRank = (s) => {
                if (s.toLowerCase().includes("popular")) return 1;
                if (s.toLowerCase().includes("soft")) return 3;
                return 2;
            };
            return getRank(a) - getRank(b);
        });

        subtiposReales.forEach(sub => {
            const colores = colorData.filter(c => c.color_type.trim() === sub);
            
            if (colores.length > 0) {
                const section = document.createElement("div");
                section.className = "sub-section";
                
                let html = `<div class="sub-title">${sub}</div>`;
                html += `<div class="color-grid">`;
                
                colores.forEach(c => {
                    const esPopular = c.color_type.toLowerCase().includes("popular");
                    html += `
                        <div class="color-card" ${esPopular ? 'style="border-color:var(--accent)"' : ''}>
                            <div class="color-sample" style="background-color: ${c.color_hex}">
                                ${esPopular ? '<span class="popular-tag">★ POPULAR</span>' : ''}
                            </div>
                            <div class="color-info">
                                <span class="color-name">${c.color_name}</span>
                                <span class="color-id">Cód: ${c.color_id}</span>
                            </div>
                        </div>`;
                });
                
                html += `</div>`;
                section.innerHTML = html;
                container.appendChild(section);
            }
        });
    }

    window.onload = loadCSV;
</script>
</body>
</html>